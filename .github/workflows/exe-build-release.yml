name: Build Windows EXE and Release

on:
  push:
    tags:
      - 'v*'  # 只在推送版本 tag 时触发（与 Docker 构建一致）
  workflow_dispatch:  # 允许手动触发

jobs:
  build-exe-and-release:
    runs-on: windows-latest
    permissions:
      contents: write  # 需要写权限来创建 Release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Extract version from pyproject.toml
        id: version
        shell: bash
        run: |
          VERSION=$(python -c "import re; print(re.search(r'version\s*=\s*\"([^\"]+)\"', open('pyproject.toml', encoding='utf-8').read()).group(1))")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Extracted version: $VERSION"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install .

      - name: Patch version for PyInstaller bundle
        shell: python
        run: |
          version = "${{ steps.version.outputs.version }}"
          with open("src/version.py", "r", encoding="utf-8") as f:
              content = f.read()
          # 将运行时版本检测替换为硬编码版本号，避免 PyInstaller 打包后路径问题
          content = content.replace(
              "__version__ = get_version()",
              f'__version__ = "{version}"'
          )
          with open("src/version.py", "w", encoding="utf-8") as f:
              f.write(content)
          print(f"Patched version to: {version}")

      - name: Build EXE with PyInstaller
        shell: bash
        run: |
          # 企业微信加解密依赖的 callback_python3 通过运行时 sys.path 加载，需随包附带
          pyinstaller --onedir --console --name WebMoniter \
            --paths . \
            --add-data "src/weworkapi_python;src/weworkapi_python" \
            --hidden-import monitors \
            --hidden-import monitors.huya_monitor \
            --hidden-import monitors.weibo_monitor \
            --hidden-import monitors.bilibili_monitor \
            --hidden-import monitors.douyin_monitor \
            --hidden-import monitors.douyu_monitor \
            --hidden-import monitors.xhs_monitor \
            --hidden-import tasks \
            --hidden-import tasks.log_cleanup \
            --hidden-import tasks.ikuuu_checkin \
            --hidden-import tasks.tieba_checkin \
            --hidden-import tasks.weibo_chaohua_checkin \
            --hidden-import tasks.rainyun_checkin \
            --hidden-import tasks.enshan_checkin \
            --hidden-import tasks.fg_checkin \
            --hidden-import tasks.aliyun_checkin \
            --hidden-import tasks.smzdm_checkin \
            --hidden-import tasks.zdm_draw \
            --hidden-import tasks.tyyun_checkin \
            --hidden-import tasks.miui_checkin \
            --hidden-import tasks.iqiyi_checkin \
            --hidden-import tasks.lenovo_checkin \
            --hidden-import tasks.lbly_checkin \
            --hidden-import tasks.pinzan_checkin \
            --hidden-import tasks.dml_checkin \
            --hidden-import tasks.xiaomao_checkin \
            --hidden-import tasks.ydwx_checkin \
            --hidden-import tasks.xingkong_checkin \
            --hidden-import tasks.qtw_checkin \
            --hidden-import tasks.freenom_checkin \
            --hidden-import tasks.weather_push \
            --hidden-import tasks.kuake_checkin \
            --hidden-import tasks.kjwj_checkin \
            --hidden-import tasks.fr_checkin \
            --hidden-import tasks.nine_nine_nine_task \
            --hidden-import tasks.zgfc_draw \
            --hidden-import tasks.ssq_500w_notice \
            --hidden-import tasks.demo_task \
            --hidden-import src.ai_assistant.rag_index_refresh \
            --hidden-import uvicorn.logging \
            --hidden-import uvicorn.loops.auto \
            --hidden-import uvicorn.protocols.http.auto \
            --hidden-import uvicorn.protocols.http.h11_impl \
            --hidden-import uvicorn.protocols.http.httptools_impl \
            --hidden-import uvicorn.protocols.websockets.auto \
            --hidden-import uvicorn.protocols.websockets.wsproto_impl \
            --hidden-import uvicorn.lifespan.on \
            --hidden-import uvicorn.lifespan.off \
            main.py

      - name: Prepare distribution
        shell: bash
        run: |
          # 复制 Web 模板和静态资源到发布目录（运行时通过 CWD 相对路径访问）
          cp -r web dist/WebMoniter/
          # 复制 pyproject.toml（用于版本号回退检测）
          cp pyproject.toml dist/WebMoniter/
          # 复制示例配置文件
          cp config.yml.sample dist/WebMoniter/
          # 复制 docs/、README.md 供 AI 助手 RAG 检索
          cp -r docs dist/WebMoniter/
          cp README.md dist/WebMoniter/

      - name: Create ZIP archive
        shell: bash
        run: |
          cd dist
          7z a -tzip "../WebMoniter-v${{ steps.version.outputs.version }}-windows-x64.zip" WebMoniter/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: WebMoniter-v${{ steps.version.outputs.version }}-windows-x64
          path: WebMoniter-v${{ steps.version.outputs.version }}-windows-x64.zip

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: WebMoniter-v${{ steps.version.outputs.version }}-windows-x64.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
