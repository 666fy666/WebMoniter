
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="多平台监控签到 · 开播提醒 · 多渠道推送 — 使用指南与二次开发">
      
      
        <meta name="author" content="FY">
      
      
        <link rel="canonical" href="https://666fy666.github.io/WebMoniter/SECONDARY_DEVELOPMENT/">
      
      
        <link rel="prev" href="../ARCHITECTURE/">
      
      
        <link rel="next" href="../API/">
      
      
        
      
      
      <link rel="icon" href="../assets/favicon.svg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>二次开发指南 - WebMoniter 文档</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href=".." title="WebMoniter 文档" class="md-header__button md-logo" aria-label="WebMoniter 文档" data-md-component="logo">
      
  <img src="../assets/favicon.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            WebMoniter 文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              二次开发指南
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="深色模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="深色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="浅色模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="浅色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/666fy666/WebMoniter" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    666fy666/WebMoniter
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../installation/" class="md-tabs__link">
          
  
  
  快速开始

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../guides/config/" class="md-tabs__link">
          
  
  
  使用指南

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../ARCHITECTURE/" class="md-tabs__link">
          
  
  
  二次开发

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../faq/" class="md-tabs__link">
          
  
  
  帮助与支持

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="WebMoniter 文档" class="md-nav__button md-logo" aria-label="WebMoniter 文档" data-md-component="logo">
      
  <img src="../assets/favicon.svg" alt="logo">

    </a>
    WebMoniter 文档
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/666fy666/WebMoniter" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    666fy666/WebMoniter
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    首页
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    快速开始
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    快速开始
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    安装与运行
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../QINGLONG/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    青龙面板部署
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    使用指南
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    使用指南
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    配置与设置
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    配置与设置
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    配置说明
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/web-ui/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Web 管理界面
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/ai-assistant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI 助手
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    任务管理
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    任务管理
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/tasks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    任务概览
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/tasks/monitors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    监控任务详解
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/tasks/checkin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    定时任务详解
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    推送与通知
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    推送与通知
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../guides/push-channels/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    推送通道配置
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    二次开发
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    二次开发
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ARCHITECTURE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    架构概览
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    二次开发指南
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    二次开发指南
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        零、开发环境与代码规范
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="零、开发环境与代码规范">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        代码检测
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="代码检测">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        安装开发依赖
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        代码格式化
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        代码检查
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        运行测试
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        一、架构简述
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ikuuu" class="md-nav__link">
    <span class="md-ellipsis">
      
        二、定时任务示例一：iKuuu 签到（顶层配置）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="二、定时任务示例一：iKuuu 签到（顶层配置）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-configyml" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 配置：config.yml
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-srcconfigpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 配置：src/config.py
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-tasksikuuu_checkinpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 任务实现：tasks/ikuuu_checkin.py
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-srcjob_registrypy" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4 注册表：src/job_registry.py
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo-plugins" class="md-nav__link">
    <span class="md-ellipsis">
      
        三、定时任务示例二：Demo 任务（plugins 配置）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="三、定时任务示例二：Demo 任务（plugins 配置）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-configyml" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 配置：config.yml
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-tasksdemo_taskpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 任务实现：tasks/demo_task.py
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        四、监控任务示例：虎牙直播监控
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="四、监控任务示例：虎牙直播监控">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-configyml" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 配置：config.yml
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-srcconfigpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 配置：src/config.py
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-monitorshuya_monitorpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 监控实现：monitors/huya_monitor.py
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-srcjob_registrypy" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4 注册表：src/job_registry.py
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5 配置热重载与数据库同步
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        五、监控任务需要数据库时该怎么办
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="五、监控任务需要数据库时该怎么办">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-basemonitor-selfdb" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 继承 BaseMonitor 即获得 self.db
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-asyncdatabase-apisrcdatabasepy" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 AsyncDatabase 常用 API（src/database.py）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-databasepy" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.3 新监控需要新表时：在 database.py 中加表
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.4 虎牙监控中的用法示例（对照代码）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.5 小结：监控 + 数据库的步骤
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        六、推送逻辑（统一说明）
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        七、示例文件与代码位置一览
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        八、检查清单：新增定时任务
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      
        九、检查清单：新增监控任务
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web" class="md-nav__link">
    <span class="md-ellipsis">
      
        十、Web 前端对新增配置的响应
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#qlpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        十一、青龙面板单任务脚本（ql/*.py）
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../API/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API 参考
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    帮助与支持
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    帮助与支持
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    常见问题
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        零、开发环境与代码规范
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="零、开发环境与代码规范">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        代码检测
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="代码检测">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        安装开发依赖
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        代码格式化
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        代码检查
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        运行测试
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        一、架构简述
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ikuuu" class="md-nav__link">
    <span class="md-ellipsis">
      
        二、定时任务示例一：iKuuu 签到（顶层配置）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="二、定时任务示例一：iKuuu 签到（顶层配置）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-configyml" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 配置：config.yml
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-srcconfigpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 配置：src/config.py
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-tasksikuuu_checkinpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 任务实现：tasks/ikuuu_checkin.py
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-srcjob_registrypy" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4 注册表：src/job_registry.py
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#demo-plugins" class="md-nav__link">
    <span class="md-ellipsis">
      
        三、定时任务示例二：Demo 任务（plugins 配置）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="三、定时任务示例二：Demo 任务（plugins 配置）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-configyml" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 配置：config.yml
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-tasksdemo_taskpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 任务实现：tasks/demo_task.py
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        四、监控任务示例：虎牙直播监控
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="四、监控任务示例：虎牙直播监控">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-configyml" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 配置：config.yml
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-srcconfigpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 配置：src/config.py
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-monitorshuya_monitorpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 监控实现：monitors/huya_monitor.py
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-srcjob_registrypy" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4 注册表：src/job_registry.py
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5 配置热重载与数据库同步
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        五、监控任务需要数据库时该怎么办
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="五、监控任务需要数据库时该怎么办">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-basemonitor-selfdb" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 继承 BaseMonitor 即获得 self.db
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-asyncdatabase-apisrcdatabasepy" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 AsyncDatabase 常用 API（src/database.py）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-databasepy" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.3 新监控需要新表时：在 database.py 中加表
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.4 虎牙监控中的用法示例（对照代码）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.5 小结：监控 + 数据库的步骤
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        六、推送逻辑（统一说明）
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        七、示例文件与代码位置一览
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        八、检查清单：新增定时任务
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      
        九、检查清单：新增监控任务
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#web" class="md-nav__link">
    <span class="md-ellipsis">
      
        十、Web 前端对新增配置的响应
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#qlpy" class="md-nav__link">
    <span class="md-ellipsis">
      
        十一、青龙面板单任务脚本（ql/*.py）
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="_1">二次开发指南：新增监控任务与定时任务<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>本文档说明如何在不改动项目核心逻辑的前提下，用最少改动接入新的<strong>监控任务</strong>或<strong>定时任务</strong>，并支持配置热重载与统一推送。<br />
下文以项目内已实现的<strong>虎牙监控</strong>（监控任务）和 <strong>iKuuu 签到 / Demo 任务</strong>（定时任务）为例，按步骤对照真实代码说明。</p>
<hr />
<h2 id="_2">零、开发环境与代码规范<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="_3">代码检测<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>项目使用 <code>black</code> 和 <code>ruff</code> 进行代码格式化和检查。</p>
<h4 id="_4">安装开发依赖<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>sync<span class="w"> </span>--extra<span class="w"> </span>dev
</code></pre></div>
<h4 id="_5">代码格式化<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p>使用 <code>black</code> 格式化代码：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 格式化所有代码</span>
uv<span class="w"> </span>run<span class="w"> </span>black<span class="w"> </span>.

<span class="c1"># 检查代码格式（不修改文件）</span>
uv<span class="w"> </span>run<span class="w"> </span>black<span class="w"> </span>--check<span class="w"> </span>.
</code></pre></div>
<h4 id="_6">代码检查<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<p>使用 <code>ruff</code> 检查代码：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查代码并自动修复</span>
uv<span class="w"> </span>run<span class="w"> </span>ruff<span class="w"> </span>check<span class="w"> </span>--fix<span class="w"> </span>.

<span class="c1"># 仅检查代码（不修复）</span>
uv<span class="w"> </span>run<span class="w"> </span>ruff<span class="w"> </span>check<span class="w"> </span>.
</code></pre></div>
<h4 id="_7">运行测试<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>uv<span class="w"> </span>run<span class="w"> </span>pytest
</code></pre></div>
<hr />
<h2 id="_8">一、架构简述<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>类型</th>
<th>触发方式</th>
<th>配置来源示例</th>
<th>项目内示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>监控任务</td>
<td>固定间隔轮询</td>
<td><code>huya.monitor_interval_seconds</code>、<code>weibo.monitor_interval_seconds</code></td>
<td>虎牙监控、微博监控</td>
</tr>
<tr>
<td>定时任务</td>
<td>Cron 每日定点</td>
<td><code>checkin.time</code>、<code>tieba.time</code>、<code>plugins.xxx.time</code></td>
<td>iKuuu 签到、贴吧签到、Demo 任务</td>
</tr>
</tbody>
</table>
<p>新增任务时只需：</p>
<ol>
<li><strong>新增配置</strong>：在 <code>config.yml</code> 中增加节点；若用顶层配置，还需在 <code>src/config.py</code> 中补充字段与解析。</li>
<li><strong>实现任务逻辑</strong>：一个无参的 async 入口函数（内部 <code>get_config(reload=True)</code>、业务逻辑、可选推送）。</li>
<li><strong>注册</strong>：在任务模块末尾调用 <code>register_monitor</code> 或 <code>register_task</code>，并在 <code>src/job_registry.py</code> 的 <code>MONITOR_MODULES</code> / <code>TASK_MODULES</code> 中追加模块路径。</li>
</ol>
<p>主入口 <code>main.py</code> 通过 <code>job_registry.discover_and_import()</code> 加载所有列出的模块并注册到调度器，<strong>无需再改 main.py</strong>。</p>
<hr />
<h2 id="ikuuu">二、定时任务示例一：iKuuu 签到（顶层配置）<a class="headerlink" href="#ikuuu" title="Permanent link">&para;</a></h2>
<p>iKuuu 签到使用<strong>顶层配置</strong>（与贴吧签到一致）：在 <code>config.yml</code> 中有独立节点 <code>checkin</code>，在 <code>AppConfig</code> 中有对应扁平字段，适合需要强类型、与现有风格统一的场景。</p>
<blockquote>
<p><strong>域名自动发现</strong>：iKuuu 的可用域名会自动从 <code>ikuuu.club</code> 提取，无需在配置中手动填写 URL。系统在每次签到时会访问 <code>ikuuu.club</code>，通过多种正则匹配和 HTTP 探测从其混淆 JS 中提取可用域名（如 <code>ikuuu.nl</code>、<code>ikuuu.fyi</code> 等），并随机选择一个使用。</p>
</blockquote>
<h3 id="21-configyml">2.1 配置：config.yml<a class="headerlink" href="#21-configyml" title="Permanent link">&para;</a></h3>
<p>在 <code>config.yml</code> 中增加与 <code>tieba</code> 同级的 <code>checkin</code> 节点（参见 <code>config.yml.sample</code>）。</p>
<p><strong>单账号示例：</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">checkin</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">your@email.com</span>
<span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">your_password</span>
<span class="w">  </span><span class="nt">time</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;08:00&quot;</span><span class="w">   </span><span class="c1"># 每日执行时间 HH:MM</span>
</code></pre></div>
<p><strong>多账号示例（<code>accounts</code> 非空时优先于单账号 <code>email</code>/<code>password</code>）：</strong></p>
<div class="highlight"><pre><span></span><code><span class="nt">checkin</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">time</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;08:00&quot;</span>
<span class="w">  </span><span class="nt">accounts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user1@example.com</span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pass1</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user2@example.com</span>
<span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pass2</span>
</code></pre></div>
<h3 id="22-srcconfigpy">2.2 配置：src/config.py<a class="headerlink" href="#22-srcconfigpy" title="Permanent link">&para;</a></h3>
<p>在 <code>AppConfig</code> 中增加扁平字段（与 YAML 的 <code>checkin</code> 一一对应）：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 每日签到配置（域名自动从 ikuuu.club 发现，无需手动配置 URL）</span>
<span class="n">checkin_enable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">checkin_email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">checkin_password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">checkin_time</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;08:00&quot;</span>
</code></pre></div>
<p>在 <code>load_config_from_yml()</code> 中从 <code>yml_config["checkin"]</code> 读到上述字段并写入 <code>config_dict</code>（如 <code>config_dict["checkin_enable"] = checkin["enable"]</code> 等）。<br />
项目内实现见 <code>src/config.py</code> 中 <code>config_mappings</code> 的 <code>checkin</code> 段及多账号 <code>accounts</code> 的特殊处理。</p>
<h3 id="23-tasksikuuu_checkinpy">2.3 任务实现：tasks/ikuuu_checkin.py<a class="headerlink" href="#23-tasksikuuu_checkinpy" title="Permanent link">&para;</a></h3>
<p><strong>① 配置校验与入口</strong></p>
<ul>
<li>使用 dataclass 从 <code>AppConfig</code> 转成任务用配置，并做 <code>validate()</code>（未启用或缺少必填项则直接 return）：</li>
<li>域名通过 <code>_extract_ikuuu_domain()</code> 自动从 <code>ikuuu.club</code> 提取，URL 由域名自动构建（<code>@property</code>）：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CheckinConfig</span><span class="p">:</span>
    <span class="n">enable</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span>    <span class="c1"># 自动发现的域名，如 ikuuu.nl</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">time</span><span class="p">:</span> <span class="nb">str</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">login_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/auth/login&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">checkin_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/user/checkin&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">user_page_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">domain</span><span class="si">}</span><span class="s2">/user&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_app_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">AppConfig</span><span class="p">,</span> <span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CheckinConfig</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">enable</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">checkin_enable</span><span class="p">,</span>
            <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
            <span class="c1"># ...</span>
            <span class="n">time</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">checkin_time</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;08:00&quot;</span><span class="p">,</span>
        <span class="p">)</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_checkin_once</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">app_config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">app_config</span><span class="o">.</span><span class="n">checkin_enable</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># 自动发现 ikuuu 可用域名</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_extract_ikuuu_domain</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">domain</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ikuuu签到：无法自动发现可用域名，跳过本次执行&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">CheckinConfig</span><span class="o">.</span><span class="n">from_app_config</span><span class="p">(</span><span class="n">app_config</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="k">return</span>
    <span class="c1"># 业务逻辑：登录 → 签到 → 获取流量信息</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">push_manager</span> <span class="o">=</span> <span class="k">await</span> <span class="n">build_push_manager</span><span class="p">(</span>
            <span class="n">app_config</span><span class="o">.</span><span class="n">push_channel_list</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">init_fail_prefix</span><span class="o">=</span><span class="s2">&quot;ikuuu签到：&quot;</span><span class="p">,</span>
            <span class="n">channel_names</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">push_channels</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">push_channels</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># 指定使用的通道</span>
        <span class="p">)</span>
        <span class="n">cookie</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_login_and_get_cookie</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cookie</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">_send_checkin_push</span><span class="p">(</span><span class="n">push_manager</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ikuuu签到失败：登录失败&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_checkin</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span>
        <span class="n">traffic_info</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_get_user_traffic</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">_send_checkin_push</span><span class="p">(</span><span class="n">push_manager</span><span class="p">,</span> <span class="n">title</span><span class="o">=...</span><span class="p">,</span> <span class="n">msg</span><span class="o">=...</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="n">ok</span><span class="p">,</span> <span class="n">traffic_info</span><span class="o">=</span><span class="n">traffic_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">push_manager</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">push_manager</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
<p><strong>② 推送逻辑</strong></p>
<ul>
<li>推送前用 <code>is_in_quiet_hours(app_cfg)</code> 判断免打扰，在免打扰时段内只打日志不推送：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_send_checkin_push</span><span class="p">(</span><span class="n">push_manager</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">traffic_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">push_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">app_cfg</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">is_in_quiet_hours</span><span class="p">(</span><span class="n">app_cfg</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;ikuuu签到：免打扰时段，不发送推送&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">await</span> <span class="n">push_manager</span><span class="o">.</span><span class="n">send_news</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">（</span><span class="si">{</span><span class="n">masked_email</span><span class="si">}</span><span class="s2">）&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=...</span><span class="p">,</span>
        <span class="n">to_url</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">user_page_url</span><span class="p">,</span>
        <span class="n">picurl</span><span class="o">=</span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
        <span class="n">btntxt</span><span class="o">=</span><span class="s2">&quot;查看账户&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
<p><strong>③ 注册：Cron 触发参数 + register_task</strong></p>
<ul>
<li>执行时间由 <code>checkin.time</code> 决定，使用公共方法 <code>parse_checkin_time</code> 得到 cron 的 <code>hour</code>、<code>minute</code>，并在模块末尾注册：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">src.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">AppConfig</span><span class="p">,</span> <span class="n">get_config</span><span class="p">,</span> <span class="n">is_in_quiet_hours</span><span class="p">,</span> <span class="n">parse_checkin_time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">src.job_registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_task</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_get_checkin_trigger_kwargs</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">AppConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="n">parse_checkin_time</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">checkin_time</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;minute&quot;</span><span class="p">:</span> <span class="n">minute</span><span class="p">,</span> <span class="s2">&quot;hour&quot;</span><span class="p">:</span> <span class="n">hour</span><span class="p">}</span>

<span class="n">register_task</span><span class="p">(</span><span class="s2">&quot;ikuuu_checkin&quot;</span><span class="p">,</span> <span class="n">run_checkin_once</span><span class="p">,</span> <span class="n">_get_checkin_trigger_kwargs</span><span class="p">)</span>
</code></pre></div>
<p><strong>④ 当天已运行则跳过（默认行为）</strong></p>
<p><code>register_task</code> 默认启用 <code>skip_if_run_today=True</code>，任务在执行前会检查当天是否已经运行过：
- 如果已运行：输出日志 <code>{job_id}: 当天已经运行过了，跳过该任务</code>，然后跳过执行
- 如果未运行：正常执行任务，成功后记录运行日期
- 如果任务执行失败：不记录运行日期，允许后续重试</p>
<p>若某个任务需要每次触发都执行（不检查当天是否已运行），可在注册时禁用：</p>
<div class="highlight"><pre><span></span><code><span class="n">register_task</span><span class="p">(</span><span class="s2">&quot;always_run_task&quot;</span><span class="p">,</span> <span class="n">run_task</span><span class="p">,</span> <span class="n">_get_trigger_kwargs</span><span class="p">,</span> <span class="n">skip_if_run_today</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<p><strong>⑤ 手动触发执行</strong></p>
<p>通过 Web 管理界面的「任务管理」页面手动触发任务时，会使用 <code>JobDescriptor.original_run_func</code>（原始执行函数），绕过"当天已运行则跳过"检查，确保任务被强制执行。这对于调试或需要立即重新执行的场景非常有用。</p>
<h3 id="24-srcjob_registrypy">2.4 注册表：src/job_registry.py<a class="headerlink" href="#24-srcjob_registrypy" title="Permanent link">&para;</a></h3>
<p>在 <code>TASK_MODULES</code> 中已包含该模块，主程序启动时会导入并执行上述 <code>register_task</code>：</p>
<div class="highlight"><pre><span></span><code><span class="n">TASK_MODULES</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;tasks.log_cleanup&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tasks.ikuuu_checkin&quot;</span><span class="p">,</span>  <span class="c1"># iKuuu 签到</span>
    <span class="s2">&quot;tasks.tieba_checkin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tasks.weibo_chaohua_checkin&quot;</span><span class="p">,</span>  <span class="c1"># 微博超话签到</span>
    <span class="c1"># ... 雨云、贴吧、阿里云盘等更多任务见 job_registry.py</span>
    <span class="s2">&quot;tasks.demo_task&quot;</span><span class="p">,</span>  <span class="c1"># 二次开发示例，不需要可移除此行</span>
<span class="p">]</span>
</code></pre></div>
<p>小结：顶层定时任务 = <strong>config.yml 节点 → AppConfig + load_config_from_yml → 任务模块（run_xxx_once + 推送 + _get_xxx_trigger_kwargs）→ register_task → TASK_MODULES 一行</strong>。</p>
<hr />
<h2 id="demo-plugins">三、定时任务示例二：Demo 任务（plugins 配置）<a class="headerlink" href="#demo-plugins" title="Permanent link">&para;</a></h2>
<p>Demo 任务使用 <strong>plugins</strong> 配置：无需改 <code>AppConfig</code> 和 <code>load_config_from_yml()</code>，只需在 <code>config.yml</code> 的 <code>plugins</code> 下增加一个 key，适合快速扩展、字段灵活的场景。</p>
<h3 id="31-configyml">3.1 配置：config.yml<a class="headerlink" href="#31-configyml" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nt">plugins</span><span class="p">:</span>
<span class="w">  </span><span class="nt">demo_task</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">time</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;08:30&quot;</span>
<span class="w">    </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Demo</span><span class="nv"> </span><span class="s">定时任务执行完成&quot;</span>
</code></pre></div>
<h3 id="32-tasksdemo_taskpy">3.2 任务实现：tasks/demo_task.py<a class="headerlink" href="#32-tasksdemo_taskpy" title="Permanent link">&para;</a></h3>
<ul>
<li>从 <code>config.plugins.get("demo_task", {})</code> 读配置；未启用则直接 return。</li>
<li>使用 <code>parse_checkin_time(plug.get("time", "08:00"))</code> 得到 cron 的 hour/minute。</li>
<li>推送前用 <code>is_in_quiet_hours(config)</code> 判断免打扰。</li>
</ul>
<p>核心片段：</p>
<div class="highlight"><pre><span></span><code><span class="n">PLUGIN_KEY</span> <span class="o">=</span> <span class="s2">&quot;demo_task&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_get_plugin_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">AppConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">plugins</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PLUGIN_KEY</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_demo_task_once</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plug</span> <span class="o">=</span> <span class="n">_get_plugin_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">plug</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">push_manager</span> <span class="o">=</span> <span class="k">await</span> <span class="n">build_push_manager</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">plug</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="s2">&quot;Demo 定时任务执行完成。&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">push_manager</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_in_quiet_hours</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">push_manager</span><span class="o">.</span><span class="n">send_news</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Demo 任务执行完成&quot;</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">push_manager</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">push_manager</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_get_demo_task_trigger_kwargs</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">AppConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">plug</span> <span class="o">=</span> <span class="n">_get_plugin_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span> <span class="o">=</span> <span class="n">parse_checkin_time</span><span class="p">((</span><span class="n">plug</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;08:00&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;minute&quot;</span><span class="p">:</span> <span class="n">minute</span><span class="p">,</span> <span class="s2">&quot;hour&quot;</span><span class="p">:</span> <span class="n">hour</span><span class="p">}</span>

<span class="n">register_task</span><span class="p">(</span><span class="s2">&quot;demo_task&quot;</span><span class="p">,</span> <span class="n">run_demo_task_once</span><span class="p">,</span> <span class="n">_get_demo_task_trigger_kwargs</span><span class="p">)</span>
</code></pre></div>
<p>在 <code>src/job_registry.py</code> 的 <code>TASK_MODULES</code> 中需包含 <code>"tasks.demo_task"</code>（当前已包含）。<br />
完整代码见 <code>tasks/demo_task.py</code>。</p>
<hr />
<h2 id="_9">四、监控任务示例：虎牙直播监控<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<p>虎牙监控按<strong>固定间隔</strong>轮询房间状态，使用顶层配置 + 继承 <code>BaseMonitor</code>，是典型的监控任务写法。</p>
<h3 id="41-configyml">4.1 配置：config.yml<a class="headerlink" href="#41-configyml" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nt">huya</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">                  </span><span class="c1"># 是否启用该监控，默认 true；设为 false 时任务暂停</span>
<span class="w">  </span><span class="nt">rooms</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">991108,333003,518518</span><span class="w">   </span><span class="c1"># 逗号分隔的房间号</span>
<span class="w">  </span><span class="nt">concurrency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">  </span><span class="nt">monitor_interval_seconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65</span><span class="w">   </span><span class="c1"># 轮询间隔（秒）</span>
</code></pre></div>
<h3 id="42-srcconfigpy">4.2 配置：src/config.py<a class="headerlink" href="#42-srcconfigpy" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>AppConfig</strong> 中增加扁平字段：<code>huya_enable</code>、<code>huya_rooms</code>、<code>huya_concurrency</code>、<code>huya_monitor_interval_seconds</code>。</li>
<li><strong>load_config_from_yml</strong>：从 <code>yml_config["huya"]</code> 读到上述字段写入 <code>config_dict</code>。</li>
<li>提供 <strong>get_huya_config()</strong> 返回结构化配置（列表 + 并发数），供监控类使用：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HuyaConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">rooms</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_huya_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HuyaConfig</span><span class="p">:</span>
    <span class="n">rooms</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">huya_rooms</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">HuyaConfig</span><span class="p">(</span><span class="n">rooms</span><span class="o">=</span><span class="n">rooms</span><span class="p">,</span> <span class="n">concurrency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">huya_concurrency</span><span class="p">)</span>
</code></pre></div>
<p>见 <code>src/config.py</code> 中 <code>HuyaConfig</code>、<code>AppConfig.get_huya_config</code> 及 <code>load_config_from_yml</code> 的 huya 段落。</p>
<h3 id="43-monitorshuya_monitorpy">4.3 监控实现：monitors/huya_monitor.py<a class="headerlink" href="#43-monitorshuya_monitorpy" title="Permanent link">&para;</a></h3>
<p><strong>① 继承 BaseMonitor</strong></p>
<ul>
<li><code>BaseMonitor</code> 负责：<code>config</code>、<code>session</code>、<code>db</code>、<code>push</code>、<code>initialize()</code>（数据库 + 推送）、<code>close()</code>。子类只需实现 <code>run()</code> 和 <code>monitor_name</code>，以及可选的 <code>_get_session</code> 重写（如固定 User-Agent/Cookie）。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">src.monitor</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseMonitor</span>

<span class="k">class</span><span class="w"> </span><span class="nc">HuyaMonitor</span><span class="p">(</span><span class="n">BaseMonitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">AppConfig</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">huya_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_huya_config</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_first_time</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_old_info</span><span class="p">()</span>   <span class="c1"># 从 DB 加载旧状态</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">new_config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="n">reload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">new_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">huya_config</span> <span class="o">=</span> <span class="n">new_config</span><span class="o">.</span><span class="n">get_huya_config</span><span class="p">()</span>
        <span class="c1"># 并发轮询房间，比对 old_data_dict，有变化则更新 DB 并 push_notification</span>
        <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">huya_config</span><span class="o">.</span><span class="n">concurrency</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">process_with_semaphore</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">huya_config</span><span class="o">.</span><span class="n">rooms</span><span class="p">]</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">monitor_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;虎牙直播监控🐯  🐯  🐯&quot;</span>
</code></pre></div>
<p><strong>② 推送</strong></p>
<ul>
<li>在业务逻辑里调用 <code>self.push.send_news(...)</code>；推送前用 <code>is_in_quiet_hours(self.config)</code> 判断免打扰，若在免打扰时段则只打日志不推送。见 <code>huya_monitor.py</code> 中 <code>push_notification</code>。</li>
</ul>
<p><strong>③ 对外入口与注册</strong></p>
<ul>
<li>对外暴露一个无参的 async 函数，内部 <code>get_config(reload=True)</code> 后 <code>async with HuyaMonitor(config) as monitor: await monitor.run()</code>。</li>
<li>提供 <code>_get_huya_trigger_kwargs(config)</code> 返回 <code>{"seconds": config.huya_monitor_interval_seconds}</code>，并在模块末尾 <code>register_monitor</code>：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_huya_monitor</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="n">reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">HuyaMonitor</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">monitor</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">monitor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_get_huya_trigger_kwargs</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">AppConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;seconds&quot;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">huya_monitor_interval_seconds</span><span class="p">}</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">src.job_registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_monitor</span>
<span class="n">register_monitor</span><span class="p">(</span><span class="s2">&quot;huya_monitor&quot;</span><span class="p">,</span> <span class="n">run_huya_monitor</span><span class="p">,</span> <span class="n">_get_huya_trigger_kwargs</span><span class="p">)</span>
</code></pre></div>
<p>见 <code>monitors/huya_monitor.py</code> 末尾。</p>
<h3 id="44-srcjob_registrypy">4.4 注册表：src/job_registry.py<a class="headerlink" href="#44-srcjob_registrypy" title="Permanent link">&para;</a></h3>
<p>在 <code>MONITOR_MODULES</code> 中已包含虎牙模块（当前全部监控模块如下）：</p>
<div class="highlight"><pre><span></span><code><span class="n">MONITOR_MODULES</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;monitors.huya_monitor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;monitors.weibo_monitor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;monitors.bilibili_monitor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;monitors.douyin_monitor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;monitors.douyu_monitor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;monitors.xhs_monitor&quot;</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div>
<h3 id="45">4.5 配置热重载与数据库同步<a class="headerlink" href="#45" title="Permanent link">&para;</a></h3>
<p>项目已对现有监控与定时任务的 <strong>enable</strong>、<strong>间隔/执行时间</strong>、<strong>免打扰</strong>、<strong>推送通道</strong>等字段做完整覆盖，修改后约 5 秒内热重载生效。<br />
<strong>新增监控任务时</strong>，需完成以下两项以支持热重载与配置同步：</p>
<ol>
<li><strong>config_watcher</strong>：在 <code>src/config_watcher.py</code> 的 <code>_config_changed()</code> 的 <code>config_groups</code> 中增加对应平台及字段（如 <code>"my_monitor": ["my_monitor_enable", "my_monitor_rooms", "my_monitor_interval_seconds"]</code>），并在 <code>scheduler</code> 组中增加 <code>my_monitor_interval_seconds</code>（若有间隔配置）。</li>
<li><strong>config_db_sync</strong>：若新监控使用 uid/room 类列表且需要从配置中删除时同步清理数据库，需在 <code>src/config_db_sync.py</code> 的 <code>sync_rules</code> 中增加对应规则（配置字段 → 表名 + 主键列名）。</li>
</ol>
<p><strong>新增定时任务时</strong>：在 <code>config_groups</code> 中增加对应任务及字段（如 <code>"my_task": ["my_task_enable", "my_task_time"]</code>）。</p>
<p>小结：监控任务 = <strong>config.yml（业务节点含 enable + scheduler 间隔）→ AppConfig + get_xxx_config + load_config_from_yml → 继承 BaseMonitor 实现 run + 推送 → run_xxx_monitor + _get_xxx_trigger_kwargs → register_monitor → MONITOR_MODULES 一行</strong>。<code>enable: false</code> 时任务会被暂停，热重载生效。</p>
<hr />
<h2 id="_10">五、监控任务需要数据库时该怎么办<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<p>很多监控任务需要<strong>持久化上一次状态</strong>（例如上次是否在播、上次微博内容），以便本次轮询时对比、仅在变化时推送。本项目的做法是：<strong>继承 BaseMonitor 即自带数据库与推送</strong>，数据库使用项目内统一的 SQLite（<code>data/data.db</code>），由 <code>AsyncDatabase</code> 封装。</p>
<h3 id="51-basemonitor-selfdb">5.1 继承 BaseMonitor 即获得 self.db<a class="headerlink" href="#51-basemonitor-selfdb" title="Permanent link">&para;</a></h3>
<p>在 <code>src/monitor.py</code> 中，<code>BaseMonitor.initialize()</code> 会：</p>
<ul>
<li>创建 <code>self.db = AsyncDatabase()</code> 并 <code>await self.db.initialize()</code>；</li>
<li>创建 <code>self.push</code>（统一推送）；</li>
<li>可选 <code>self.session</code>（HTTP）。</li>
</ul>
<p>因此你的监控类<strong>只需继承 BaseMonitor</strong>，在 <code>initialize()</code> 里可先 <code>await super().initialize()</code>，再加载本监控需要的“旧数据”；在 <code>run()</code> 里用 <code>self.db</code> 做查询/更新/插入即可。无需自己 new AsyncDatabase 或管理连接。</p>
<h3 id="52-asyncdatabase-apisrcdatabasepy">5.2 AsyncDatabase 常用 API（src/database.py）<a class="headerlink" href="#52-asyncdatabase-apisrcdatabasepy" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
<th>返回值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>execute_query(sql, params=None)</code></td>
<td>查询，占位符用 <code>%(key)s</code>，params 为 dict</td>
<td><code>list[tuple]</code>，每行一个元组</td>
</tr>
<tr>
<td><code>execute_update(sql, params=None)</code></td>
<td>执行 UPDATE/INSERT/DELETE</td>
<td><code>bool</code>（是否成功）</td>
</tr>
<tr>
<td><code>execute_insert(sql, params=None)</code></td>
<td>同 execute_update，语义上用于插入</td>
<td><code>bool</code></td>
</tr>
<tr>
<td><code>is_table_empty(table_name)</code></td>
<td>判断表是否为空（可用于“首次运行”逻辑）</td>
<td><code>bool</code></td>
</tr>
</tbody>
</table>
<ul>
<li><strong>SQL 占位符</strong>：写 <code>%(name)s</code>、<code>%(room)s</code> 等，params 传字典如 <code>{"name": "xx", "room": "123"}</code>。模块内部会转换为 SQLite 的 <code>:name</code> 格式，无需改 SQL。</li>
<li><strong>连接</strong>：默认使用全局共享连接（单进程内复用），重试与重连已在 <code>execute_*</code> 内处理。</li>
</ul>
<h3 id="53-databasepy">5.3 新监控需要新表时：在 database.py 中加表<a class="headerlink" href="#53-databasepy" title="Permanent link">&para;</a></h3>
<p>当前所有表结构都在 <code>src/database.py</code> 的 <code>_init_tables()</code> 里统一创建（<code>CREATE TABLE IF NOT EXISTS ...</code>）。<br />
若你的监控需要<strong>自己的表</strong>（例如 <code>my_monitor</code>），在 <strong><code>src/database.py</code></strong> 的 <strong><code>_init_tables()</code></strong> 中增加一段即可，与现有 <code>weibo</code>、<code>huya</code> 表并列，例如：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 在 _init_tables(self, conn) 末尾、await conn.commit() 前增加：</span>

<span class="c1"># 创建 my_monitor 表（示例）</span>
<span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CREATE TABLE IF NOT EXISTS my_monitor (</span>
<span class="sd">        id TEXT PRIMARY KEY,</span>
<span class="sd">        name TEXT,</span>
<span class="sd">        status TEXT,</span>
<span class="sd">        updated_at TEXT</span>
<span class="sd">    )</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="p">)</span>
<span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>
<p>表名、字段名按你的业务设计即可；主键建议能唯一标识一条监控对象（如房间号、用户 ID）。</p>
<h3 id="54">5.4 虎牙监控中的用法示例（对照代码）<a class="headerlink" href="#54" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>加载旧数据</strong>（在 <code>initialize()</code> 里调用，或 <code>run()</code> 开头）：<br />
  用 <code>execute_query</code> 把上一轮存的状态读进内存，供本轮对比：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_old_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT room, name, is_live FROM huya&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute_query</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">old_data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_is_first_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_data_dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</code></pre></div>
<ul>
<li><strong>有变化时更新</strong>：<br />
  用 <code>execute_update</code>，占位符与字典一一对应：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;UPDATE huya SET name=</span><span class="si">%(name)s</span><span class="s2">, is_live=</span><span class="si">%(is_live)s</span><span class="s2"> WHERE room=</span><span class="si">%(room)s</span><span class="s2">&quot;</span>
<span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute_update</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</code></pre></div>
<ul>
<li><strong>新对象首次写入</strong>：<br />
  用 <code>execute_insert</code>：</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;INSERT INTO huya (room, name, is_live) VALUES (</span><span class="si">%(room)s</span><span class="s2">, </span><span class="si">%(name)s</span><span class="s2">, </span><span class="si">%(is_live)s</span><span class="s2">)&quot;</span>
<span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">execute_insert</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</code></pre></div>
<ul>
<li><strong>首次建表/首次运行</strong>：<br />
  虎牙用 <code>_is_first_time</code> 标记“表里之前没有数据”。首次跑满一轮时只写入 DB、不推送，避免历史数据被当成“新变化”刷屏；从第二轮开始才按变化推送。你可按同样思路处理。</li>
</ul>
<p>完整实现见 <code>monitors/huya_monitor.py</code>（<code>load_old_info</code>、<code>process_room</code> 中的 SQL 与 <code>self.db</code> 调用）。</p>
<h3 id="55">5.5 小结：监控 + 数据库的步骤<a class="headerlink" href="#55" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>继承 BaseMonitor</strong>，在 <code>initialize()</code> 里 <code>await super().initialize()</code> 后加载旧数据到内存（如 <code>load_old_info</code>）。</li>
<li>在 <strong><code>src/database.py</code> 的 <code>_init_tables()</code></strong> 里为你的监控<strong>增加 CREATE TABLE IF NOT EXISTS</strong>（若需要新表）。</li>
<li>在 <code>run()</code> 里：拉取当前数据 → 与旧数据对比 → 有变化则 <code>execute_update</code> / <code>execute_insert</code> 更新 DB，并调用 <code>self.push.send_news(...)</code>；无变化则只打日志。</li>
<li>SQL 使用 <strong><code>%(key)s</code> + dict 参数</strong>，通过 <code>self.db.execute_query</code> / <code>execute_update</code> / <code>execute_insert</code> 访问；连接与重试由 AsyncDatabase 统一处理。</li>
</ol>
<hr />
<h2 id="_11">六、推送逻辑（统一说明）<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<ul>
<li>推送通道统一来自 <code>config.push_channel_list</code>（即 <code>config.yml</code> 的 <code>push_channel</code>），无需在任务里新增通道类型。</li>
<li><strong>通道选择机制</strong>：每个任务可以在配置中通过 <code>push_channels</code> 字段指定使用哪些推送通道（按名称匹配）。为空时使用全部已配置的通道。</li>
<li>在任务/监控内：</li>
<li>使用 <code>await build_push_manager(config.push_channel_list, session, logger, init_fail_prefix="任务名：", channel_names=["通道1", "通道2"])</code> 得到 <code>UnifiedPushManager</code>。<code>channel_names</code> 参数可选，用于指定仅初始化哪些通道（按 <code>name</code> 字段匹配），为空或 None 时使用全部通道。</li>
<li>需要推送时调用 <code>await push_manager.send_news(title=..., description=..., to_url=..., picurl=..., btntxt=...)</code>。</li>
<li>遵守免打扰：推送前 <code>if is_in_quiet_hours(config): return</code>（或只打日志），再调用 <code>send_news</code>。</li>
<li>使用完毕后 <code>await push_manager.close()</code>。</li>
</ul>
<p>虎牙在类内使用 <code>self.push</code>（BaseMonitor 在 <code>initialize</code> 里已创建，会自动读取任务配置的 <code>push_channels</code>）；iKuuu/Demo 在 async 函数内自己创建 <code>push_manager</code> 并在同一 session 生命周期内 close。<br />
推送失败建议用 <code>logger.error(..., exc_info=True)</code> 记录，不中断主流程。</p>
<p><strong>任务专属日志</strong>：新增任务无需额外处理，系统会在执行时自动将输出写入 <code>task_{job_id}_YYYYMMDD.log</code>。Handler 挂载在 root logger，可捕获任务内所有 logger（模块、类、推送通道等）的输出。</p>
<hr />
<h2 id="_12">七、示例文件与代码位置一览<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>类型</th>
<th>示例</th>
<th>配置文件</th>
<th>配置解析</th>
<th>任务/监控实现</th>
<th>注册</th>
</tr>
</thead>
<tbody>
<tr>
<td>定时任务</td>
<td>iKuuu 签到</td>
<td><code>config.yml</code> → <code>checkin</code></td>
<td><code>AppConfig</code> + <code>load_config_from_yml</code>（checkin 段）</td>
<td><code>tasks/ikuuu_checkin.py</code>（<code>run_checkin_once</code>、<code>_send_checkin_push</code>、<code>_get_checkin_trigger_kwargs</code>）</td>
<td><code>register_task("ikuuu_checkin", ...)</code>，<code>TASK_MODULES</code> 含 <code>tasks.ikuuu_checkin</code></td>
</tr>
<tr>
<td>定时任务</td>
<td>Demo 任务</td>
<td><code>config.yml</code> → <code>plugins.demo_task</code></td>
<td>无需改 config.py，用 <code>config.plugins.get("demo_task")</code></td>
<td><code>tasks/demo_task.py</code></td>
<td><code>register_task("demo_task", ...)</code>，<code>TASK_MODULES</code> 含 <code>tasks.demo_task</code></td>
</tr>
<tr>
<td>定时任务</td>
<td>Freenom 续期</td>
<td><code>config.yml</code> → <code>freenom</code></td>
<td><code>AppConfig</code> + <code>load_config_from_yml</code>（freenom 段，多账号 accounts）</td>
<td><code>tasks/freenom_checkin.py</code>（<code>run_freenom_checkin_once</code>、<code>_get_freenom_trigger_kwargs</code>）</td>
<td><code>register_task("freenom_checkin", ...)</code>，<code>TASK_MODULES</code> 含 <code>tasks.freenom_checkin</code></td>
</tr>
<tr>
<td>定时任务</td>
<td>天气推送</td>
<td><code>config.yml</code> → <code>weather</code></td>
<td><code>AppConfig</code> + <code>load_config_from_yml</code>（weather 段）</td>
<td><code>tasks/weather_push.py</code>（<code>run_weather_push_once</code>、<code>_get_weather_trigger_kwargs</code>）</td>
<td><code>register_task("weather_push", ...)</code>，<code>TASK_MODULES</code> 含 <code>tasks.weather_push</code></td>
</tr>
<tr>
<td>监控任务</td>
<td>虎牙监控</td>
<td><code>config.yml</code> → <code>huya</code>（含 <code>monitor_interval_seconds</code>）</td>
<td><code>AppConfig</code>、<code>HuyaConfig</code>、<code>get_huya_config</code>、<code>load_config_from_yml</code>（huya 段）</td>
<td><code>monitors/huya_monitor.py</code>（<code>HuyaMonitor</code>、<code>run_huya_monitor</code>、<code>_get_huya_trigger_kwargs</code>）</td>
<td><code>register_monitor("huya_monitor", ...)</code>，<code>MONITOR_MODULES</code> 含 <code>monitors.huya_monitor</code></td>
</tr>
</tbody>
</table>
<ul>
<li><strong>parse_checkin_time</strong>：<code>src/config.py</code>，将 <code>"HH:MM"</code> 解析为 <code>(hour, minute)</code> 字符串元组，供 Cron 使用。</li>
<li><strong>BaseMonitor</strong>：<code>src/monitor.py</code>，提供 <code>config</code>、<code>db</code>、<code>push</code>、<code>initialize</code>、<code>close</code>，子类实现 <code>run</code>、<code>monitor_name</code>。</li>
</ul>
<hr />
<h2 id="_13">八、检查清单：新增定时任务<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h2>
<ul>
<li>[ ] 在 <code>config.yml</code> 中增加配置（顶层节点或 <code>plugins.xxx</code>）。</li>
<li>[ ] 若用顶层配置：在 <code>AppConfig</code> 与 <code>load_config_from_yml()</code> 中补充字段；若用 <code>plugins</code>，无需改 config.py。</li>
<li>[ ] 新建 <code>tasks/xxx.py</code>，实现 <code>run_xxx_once()</code>（内部 <code>get_config(reload=True)</code>、校验、业务、推送）、<code>_get_xxx_trigger_kwargs(config)</code>（返回 <code>{"minute": m, "hour": h}</code>，可用 <code>parse_checkin_time</code>）。</li>
<li>[ ] 在模块末尾调用 <code>register_task("job_id", run_xxx_once, _get_xxx_trigger_kwargs)</code>。</li>
<li>默认启用 <code>skip_if_run_today=True</code>，当天已运行则跳过</li>
<li>若需每次触发都执行，设置 <code>skip_if_run_today=False</code></li>
<li>[ ] 在 <code>src/job_registry.TASK_MODULES</code> 中追加 <code>"tasks.xxx"</code>。</li>
<li>[ ] 若使用新的顶层配置项，需在 <code>config_watcher._config_changed</code> 中增加对应比较（plugins 已支持）。</li>
</ul>
<hr />
<h2 id="_14">九、检查清单：新增监控任务<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h2>
<ul>
<li>[ ] 在 <code>config.yml</code> 中增加业务节点（如 <code>my_monitor</code>），并在该节点下增加 <code>monitor_interval_seconds</code> 字段（例如 <code>my_monitor.monitor_interval_seconds</code>）。</li>
<li>[ ] 在 <code>AppConfig</code> 中增加扁平字段，在 <code>load_config_from_yml()</code> 中解析；可选：提供 <code>get_my_monitor_config()</code> 返回结构化配置。</li>
<li>[ ] 在 <code>config_watcher._config_changed</code> 的 <code>config_groups</code> 中增加新平台及字段；若使用间隔，在 <code>scheduler</code> 组中增加 <code>my_monitor_interval_seconds</code>。</li>
<li>[ ] 若监控使用 uid/room 类列表且需配置删除时同步清理 DB：在 <code>config_db_sync.sync_rules</code> 中增加对应规则。</li>
<li>[ ] 新建 <code>monitors/xxx.py</code>，继承 <code>BaseMonitor</code> 实现 <code>run()</code>、<code>monitor_name</code>，以及 <code>run_xxx_monitor()</code>、<code>_get_xxx_trigger_kwargs(config)</code>（返回 <code>{"seconds": config.xxx_interval_seconds}</code>）。</li>
<li>[ ] <strong>若监控需要数据库</strong>：在 <code>src/database.py</code> 的 <code>_init_tables()</code> 中增加 <code>CREATE TABLE IF NOT EXISTS your_table (...)</code>；在监控类 <code>initialize()</code> 里加载旧数据，在 <code>run()</code> 里用 <code>self.db.execute_query</code> / <code>execute_update</code> / <code>execute_insert</code> 读写（参见 <strong>五、监控任务需要数据库时该怎么办</strong>）。</li>
<li>[ ] 在模块末尾调用 <code>register_monitor("job_id", run_xxx_monitor, _get_xxx_trigger_kwargs)</code>。</li>
<li>[ ] 在 <code>src/job_registry.MONITOR_MODULES</code> 中追加 <code>"monitors.xxx"</code>。</li>
<li>[ ] 若该监控支持 <code>enable</code> 开关：在 <code>src/job_registry.MONITOR_JOB_ENABLE_FIELD_MAP</code> 中增加映射，如 <code>"xxx_monitor": "xxx_enable"</code>。</li>
</ul>
<p>完成以上步骤后，新任务会被主程序自动加载、按配置调度，并在配置变更时通过 ConfigWatcher 热重载。</p>
<hr />
<h2 id="web">十、Web 前端对新增配置的响应<a class="headerlink" href="#web" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>文本视图</strong>：直接读写整份 <code>config.yml</code>，新增的任意 key（如 <code>plugins</code>、<code>freenom</code>、<code>weather</code> 等）都会完整显示、可编辑，保存后整份写回，<strong>会正确响应</strong>。</li>
<li><strong>表格视图</strong>：当前展示微博、虎牙、各类签到任务（iKuuu、贴吧、雨云、恩山、阿里云盘、什么值得买、Freenom、夸克、科技玩家、帆软、999、zgfc、双色球等）、调度器、免打扰、推送通道以及<strong>插件配置</strong>等固定区块。</li>
<li>在表格视图中修改并保存时，后端会<strong>合并</strong>写回，因此文件中已有的 <code>plugins</code> 或其他顶层节点不会丢失。  </li>
<li>插件配置可在配置页底部的「插件/扩展配置」中以 JSON 形式编辑 <code>config.plugins</code>；尚未在表格中单独列出的顶层 key 需使用文本视图编辑。</li>
</ul>
<p>若你新增了与现有区块同级的配置（例如新的顶层节点），并希望在表格中编辑，需在 Web 前端增加对应卡片及 <code>loadSectionConfig</code> / <code>collectSectionConfig</code> / <code>collectConfig</code> 的处理（可参考本文档中已集成的 <code>freenom</code>/<code>weather</code>/<code>kuake</code>/<code>kjwj</code> 等实现方式）。</p>
<hr />
<h2 id="qlpy">十一、青龙面板单任务脚本（ql/*.py）<a class="headerlink" href="#qlpy" title="Permanent link">&para;</a></h2>
<p>青龙环境下，主程序不运行，而是由青龙按 Cron 调用 <code>ql/*.py</code> 单任务脚本。这些脚本：</p>
<ul>
<li>通过 <code>ql/_runner.py</code> 作为统一入口，根据脚本名或命令行参数调用对应任务逻辑</li>
<li>配置来自<strong>环境变量</strong>（<code>WEBMONITER_*</code> 前缀），由 <code>src/ql_compat.py</code> 的 <code>load_config_from_env()</code> 解析</li>
<li>推送通过 <strong>qlapi</strong> 通道，调用青龙内置的 <code>QLAPI.systemNotify</code></li>
<li>与 <code>tasks/*</code>、<code>monitors/*</code> 主流程解耦，共用同一套业务逻辑（如签到、监控 API 调用）</li>
</ul>
<p><strong>新增青龙脚本</strong>：复制 <code>ql/ikuuu_checkin.py</code> 等示例，按需修改任务名、环境变量名，并在 <code>ql/_runner.py</code> 中注册。详见 <a href="../QINGLONG/">青龙面板兼容指南</a>。</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; FY · MIT License
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/666fy666/WebMoniter" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.tabs.link", "content.code.copy"], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>