<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置管理 - Web任务系统</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/css/style.css?v=6">
</head>
<body>
    <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="菜单">☰</button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Web任务系统</h2>
        </div>
        <nav class="sidebar-nav">
            <a href="/config" class="nav-item active">
                <span class="nav-icon">⚙️</span>
                <span class="nav-text">配置管理</span>
            </a>
            <a href="/tasks" class="nav-item">
                <span class="nav-icon">📋</span>
                <span class="nav-text">任务管理</span>
            </a>
            <a href="/data" class="nav-item">
                <span class="nav-icon">📊</span>
                <span class="nav-text">数据展示</span>
            </a>
            <a href="/logs" class="nav-item">
                <span class="nav-icon">📝</span>
                <span class="nav-text">日志查看</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <button id="changePasswordBtn" class="btn btn-secondary" style="margin-bottom: 10px;">
                <span>🔐</span>
                修改密码
            </button>
            <button id="logoutBtn" class="btn btn-secondary">
                <span>🚪</span>
                退出登录
            </button>
        </div>
        <div class="version-info">
            <span id="currentVersion">加载中...</span>
        </div>
    </div>

    <!-- 修改密码模态框 -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>修改密码</h3>
                <button class="modal-close" id="closePasswordModal">&times;</button>
            </div>
            <form id="changePasswordForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="oldPassword">当前密码</label>
                        <input type="password" id="oldPassword" name="old_password" required placeholder="请输入当前密码">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">新密码</label>
                        <input type="password" id="newPassword" name="new_password" required placeholder="请输入新密码（至少3个字符）">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">确认新密码</label>
                        <input type="password" id="confirmPassword" name="confirm_password" required placeholder="请再次输入新密码">
                    </div>
                    <div id="passwordMessage" class="password-message"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelPasswordChange">取消</button>
                    <button type="submit" class="btn btn-primary">确认修改</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 版本更新提示横幅 -->
    <div id="updateBanner" class="update-banner">
        <div class="update-banner-content">
            <span class="update-banner-icon">🎉</span>
            <span class="update-banner-text">
                发现新版本 <strong id="latestVersion"></strong>！
                <a id="releasesLink" href="#" target="_blank">前往更新</a>
            </span>
        </div>
        <button id="dismissUpdateBanner" class="update-banner-close" title="关闭">&times;</button>
    </div>

    <div class="main-content">
        <div class="content-header">
            <h1>配置管理</h1>
            <p class="subtitle">修改配置文件，保存后会自动热重载生效</p>
        </div>
        <div class="content-body">
            
            <!-- 视图切换标签 -->
            <div class="tabs" style="margin-bottom: 24px;">
                <button class="tab-btn active" data-view="table">📋 表格视图</button>
                <button class="tab-btn" data-view="text">📝 文本视图</button>
            </div>
            
            <!-- 表格视图容器 -->
            <div id="tableView" class="view-container">
            <!-- 微博监控配置 -->
            <div class="card config-section fade-in" data-section="weibo">
                <div class="card-header">
                    <h2>📱 微博监控配置</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary section-reload-btn">
                            <span>🔄</span>
                            重新加载
                        </button>
                        <button class="btn btn-primary section-save-btn">
                            <span>💾</span>
                            保存配置
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="config-table">
                        <tr>
                            <td class="config-label">Cookie</td>
                            <td><input type="text" id="weibo_cookie" class="form-input" placeholder="请输入微博Cookie"></td>
                        </tr>
                        <tr>
                            <td class="config-label">UID列表</td>
                            <td><textarea id="weibo_uids" class="form-textarea" rows="3" placeholder="请输入UID列表，逗号分隔"></textarea></td>
                        </tr>
                        <tr>
                            <td class="config-label">并发数</td>
                            <td><input type="number" id="weibo_concurrency" class="form-input" min="1" max="10" placeholder="建议2-5"></td>
                        </tr>
                        <tr>
                            <td class="config-label">推送通道</td>
                            <td>
                                <div id="weibo_push_channels" class="push-channels-select"></div>
                                <p class="help-text">不选择则使用全部已配置的通道</p>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- 微博超话签到配置 -->
            <div class="card config-section fade-in" data-section="weibo_chaohua" style="animation-delay: 0.05s;">
                <div class="card-header">
                    <h2>💬 微博超话签到配置</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary section-reload-btn">
                            <span>🔄</span>
                            重新加载
                        </button>
                        <button class="btn btn-primary section-save-btn">
                            <span>💾</span>
                            保存配置
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="config-table">
                        <tr>
                            <td class="config-label">启用微博超话签到</td>
                            <td>
                                <label class="switch">
                                    <input type="checkbox" id="weibo_chaohua_enable">
                                    <span class="slider"></span>
                                </label>
                                <span class="switch-label" id="weibo_chaohua_enable_label">关闭</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="config-label">Cookie（单条）</td>
                            <td><input type="text" id="weibo_chaohua_cookie" class="form-input" placeholder="微博 Cookie（须包含 XSRF-TOKEN），多 Cookie 时可不填"></td>
                        </tr>
                        <tr>
                            <td class="config-label">多 Cookie</td>
                            <td>
                                <div id="weibo_chaohua_cookies_list" class="multi-cookies-list"></div>
                                <button type="button" id="weibo_chaohua_add_cookie_btn" class="btn btn-secondary" style="margin-top: 10px;">
                                    <span>➕</span>
                                    添加 Cookie
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td class="config-label">签到时间</td>
                            <td><input type="time" id="weibo_chaohua_time" class="form-input" value="23:45"></td>
                        </tr>
                        <tr>
                            <td class="config-label">推送通道</td>
                            <td>
                                <div id="weibo_chaohua_push_channels" class="push-channels-select"></div>
                                <p class="help-text">不选择则使用全部已配置的通道</p>
                            </td>
                        </tr>
                    </table>
                    <div class="help-box" style="margin-top: 16px;">
                        <p>使用 Cookie 作为参数，须包含 XSRF-TOKEN。配置多 Cookie 后会对每个账号依次签到并分别推送。系统会在指定时间自动执行微博超话签到，项目启动时若启用也会执行一次。</p>
                    </div>
                </div>
            </div>

            <!-- 虎牙监控配置 -->
            <div class="card config-section fade-in" data-section="huya" style="animation-delay: 0.1s;">
                <div class="card-header">
                    <h2>🎮 虎牙监控配置</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary section-reload-btn">
                            <span>🔄</span>
                            重新加载
                        </button>
                        <button class="btn btn-primary section-save-btn">
                            <span>💾</span>
                            保存配置
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="config-table">
                        <tr>
                            <td class="config-label">房间号列表</td>
                            <td><textarea id="huya_rooms" class="form-textarea" rows="3" placeholder="请输入房间号列表，逗号分隔"></textarea></td>
                        </tr>
                        <tr>
                            <td class="config-label">并发数</td>
                            <td><input type="number" id="huya_concurrency" class="form-input" min="1" max="20" placeholder="建议5-10"></td>
                        </tr>
                        <tr>
                            <td class="config-label">推送通道</td>
                            <td>
                                <div id="huya_push_channels" class="push-channels-select"></div>
                                <p class="help-text">不选择则使用全部已配置的通道</p>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- ikuuu签到配置 -->
            <div class="card config-section fade-in" data-section="checkin" style="animation-delay: 0.15s;">
                <div class="card-header">
                    <h2>📅 ikuuu签到配置</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary section-reload-btn">
                            <span>🔄</span>
                            重新加载
                        </button>
                        <button class="btn btn-primary section-save-btn">
                            <span>💾</span>
                            保存配置
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="config-table">
                        <tr>
                            <td class="config-label">启用ikuuu签到</td>
                            <td>
                                <label class="switch">
                                    <input type="checkbox" id="checkin_enable">
                                    <span class="slider"></span>
                                </label>
                                <span class="switch-label" id="checkin_enable_label">关闭</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="config-label">登录地址</td>
                            <td><input type="text" id="checkin_login_url" class="form-input" placeholder="例如：https://ikuuu.de/auth/login"></td>
                        </tr>
                        <tr>
                            <td class="config-label">签到接口地址</td>
                            <td><input type="text" id="checkin_checkin_url" class="form-input" placeholder="例如：https://ikuuu.de/user/checkin"></td>
                        </tr>
                        <tr>
                            <td class="config-label">用户信息页地址</td>
                            <td><input type="text" id="checkin_user_page_url" class="form-input" placeholder="例如：https://ikuuu.de/user（可选，用于解析流量信息）"></td>
                        </tr>
                        <tr>
                            <td class="config-label">登录账号（单账号）</td>
                            <td><input type="text" id="checkin_email" class="form-input" placeholder="邮箱或用户名，多账号时可不填"></td>
                        </tr>
                        <tr>
                            <td class="config-label">登录密码（单账号）</td>
                            <td><input type="password" id="checkin_password" class="form-input" placeholder="登录密码，多账号时可不填"></td>
                        </tr>
                        <tr>
                            <td class="config-label">多账号</td>
                            <td>
                                <div id="checkin_accounts_list" class="multi-accounts-list"></div>
                                <button type="button" id="checkin_add_account_btn" class="btn btn-secondary" style="margin-top: 10px;">
                                    <span>➕</span>
                                    添加账号
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td class="config-label">签到时间</td>
                            <td><input type="time" id="checkin_time" class="form-input" value="08:00"></td>
                        </tr>
                        <tr>
                            <td class="config-label">推送通道</td>
                            <td>
                                <div id="checkin_push_channels" class="push-channels-select"></div>
                                <p class="help-text">不选择则使用全部已配置的通道</p>
                            </td>
                        </tr>
                    </table>
                    <div class="help-box" style="margin-top: 16px;">
                        <p>系统会在指定时间自动执行签到任务，项目启动时也会先执行一次签到。配置多账号后会对每个账号依次签到并分别推送。</p>
                    </div>
                </div>
            </div>

            <!-- 贴吧签到配置 -->
            <div class="card config-section fade-in" data-section="tieba" style="animation-delay: 0.2s;">
                <div class="card-header">
                    <h2>📌 贴吧签到配置</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary section-reload-btn">
                            <span>🔄</span>
                            重新加载
                        </button>
                        <button class="btn btn-primary section-save-btn">
                            <span>💾</span>
                            保存配置
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="config-table">
                        <tr>
                            <td class="config-label">启用贴吧签到</td>
                            <td>
                                <label class="switch">
                                    <input type="checkbox" id="tieba_enable">
                                    <span class="slider"></span>
                                </label>
                                <span class="switch-label" id="tieba_enable_label">关闭</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="config-label">Cookie（单条）</td>
                            <td><input type="text" id="tieba_cookie" class="form-input" placeholder="贴吧 Cookie（须包含 BDUSS），多 Cookie 时可不填"></td>
                        </tr>
                        <tr>
                            <td class="config-label">多 Cookie</td>
                            <td>
                                <div id="tieba_cookies_list" class="multi-cookies-list"></div>
                                <button type="button" id="tieba_add_cookie_btn" class="btn btn-secondary" style="margin-top: 10px;">
                                    <span>➕</span>
                                    添加 Cookie
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td class="config-label">签到时间</td>
                            <td><input type="time" id="tieba_time" class="form-input" value="08:10"></td>
                        </tr>
                        <tr>
                            <td class="config-label">推送通道</td>
                            <td>
                                <div id="tieba_push_channels" class="push-channels-select"></div>
                                <p class="help-text">不选择则使用全部已配置的通道</p>
                            </td>
                        </tr>
                    </table>
                    <div class="help-box" style="margin-top: 16px;">
                        <p>使用 Cookie 作为参数，须包含 BDUSS。配置多 Cookie 后会对每个账号依次签到并分别推送。系统会在指定时间自动执行贴吧签到，项目启动时若启用也会执行一次。</p>
                    </div>
                </div>
            </div>

            <!-- 调度器配置 -->
            <div class="card config-section fade-in" data-section="scheduler" style="animation-delay: 0.25s;">
                <div class="card-header">
                    <h2>⏰ 调度器配置</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary section-reload-btn">
                            <span>🔄</span>
                            重新加载
                        </button>
                        <button class="btn btn-primary section-save-btn">
                            <span>💾</span>
                            保存配置
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="config-table">
                        <tr>
                            <td class="config-label">虎牙监控间隔（秒）</td>
                            <td><input type="number" id="huya_monitor_interval_seconds" class="form-input" min="1" placeholder="默认65秒"></td>
                        </tr>
                        <tr>
                            <td class="config-label">微博监控间隔（秒）</td>
                            <td><input type="number" id="weibo_monitor_interval_seconds" class="form-input" min="1" placeholder="默认300秒（5分钟）"></td>
                        </tr>
                        <tr>
                            <td class="config-label">日志清理时间（小时）</td>
                            <td><input type="number" id="cleanup_logs_hour" class="form-input" min="0" max="23" placeholder="默认2点"></td>
                        </tr>
                        <tr>
                            <td class="config-label">日志清理时间（分钟）</td>
                            <td><input type="number" id="cleanup_logs_minute" class="form-input" min="0" max="59" placeholder="默认0分"></td>
                        </tr>
                        <tr>
                            <td class="config-label">日志保留天数</td>
                            <td><input type="number" id="retention_days" class="form-input" min="1" placeholder="默认3天"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- 免打扰时段配置 -->
            <div class="card config-section fade-in" data-section="quiet_hours" style="animation-delay: 0.3s;">
                <div class="card-header">
                    <h2>🔕 免打扰时段配置</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary section-reload-btn">
                            <span>🔄</span>
                            重新加载
                        </button>
                        <button class="btn btn-primary section-save-btn">
                            <span>💾</span>
                            保存配置
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="config-table">
                        <tr>
                            <td class="config-label">启用免打扰时段</td>
                            <td>
                                <label class="switch">
                                    <input type="checkbox" id="quiet_hours_enable">
                                    <span class="slider"></span>
                                </label>
                                <span class="switch-label" id="quiet_hours_enable_label">关闭</span>
                            </td>
                        </tr>
                        <tr>
                            <td class="config-label">开始时间</td>
                            <td><input type="time" id="quiet_hours_start" class="form-input" placeholder="HH:MM"></td>
                        </tr>
                        <tr>
                            <td class="config-label">结束时间</td>
                            <td><input type="time" id="quiet_hours_end" class="form-input" placeholder="HH:MM"></td>
                        </tr>
                    </table>
                    <div class="help-box" style="margin-top: 16px;">
                        <p class="warning">⚠️ 开启此功能后，在免打扰时段内的监控任务将继续执行，但不会推送通知给用户</p>
                    </div>
                </div>
            </div>

            <!-- 推送通道配置 -->
            <div class="card config-section fade-in" data-section="push_channel" style="animation-delay: 0.35s;">
                <div class="card-header">
                    <h2>📢 推送通道配置</h2>
                </div>
                <div class="card-body">
                    <div id="pushChannelsContainer">
                        <!-- 推送通道将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 插件/扩展配置（二次开发，如 plugins.demo_task） -->
            <div class="card config-section fade-in" data-section="plugins" style="animation-delay: 0.4s;">
                <div class="card-header">
                    <h2>🔌 插件/扩展配置</h2>
                    <div class="card-actions">
                        <button class="btn btn-secondary section-reload-btn">
                            <span>🔄</span>
                            重新加载
                        </button>
                        <button class="btn btn-primary section-save-btn">
                            <span>💾</span>
                            保存配置
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="config-table">
                        <tr>
                            <td class="config-label">plugins（JSON）</td>
                            <td>
                                <textarea id="plugins_json" class="form-textarea yaml-editor" rows="8" placeholder='{"demo_task": {"enable": false, "time": "08:30", "message": "说明"}}'></textarea>
                            </td>
                        </tr>
                    </table>
                    <div class="help-box" style="margin-top: 16px;">
                        <p>用于二次开发的扩展配置，对应 config.yml 中的 <code style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px;">plugins</code>。格式为 JSON，与 YAML 中的结构一致。详见项目内 <code style="background: #e2e8f0; padding: 2px 6px; border-radius: 4px;">docs/SECONDARY_DEVELOPMENT.md</code>。</p>
                    </div>
                </div>
            </div>
            </div>
            
            <!-- 文本视图容器 -->
            <div id="textView" class="view-container" style="display: none;">
                <div class="card fade-in">
                    <div class="card-header">
                        <h2>📄 配置文件（YAML格式）</h2>
                        <div class="card-actions">
                            <button id="reloadYamlBtn" class="btn btn-secondary">
                                <span>🔄</span>
                                重新加载
                            </button>
                            <button id="saveYamlBtn" class="btn btn-primary">
                                <span>💾</span>
                                保存配置
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <textarea id="yamlEditor" class="yaml-editor" placeholder="加载配置文件中..."></textarea>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <script src="/static/js/common.js?v=6"></script>
    <script src="/static/js/config.js?v=2"></script>
</body>
</html>
